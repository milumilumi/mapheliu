<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>闭合多边形测面积</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }
    #panel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: sans-serif;
      z-index: 999;
    }
  </style>
</head>
<body>
  

  <!-- ✅ 一定要带 geometry 库 -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1DDVsoYSslYif9JG1EmZt04uUWiZGJgE&libraries=geometry&callback=initMap"></script>
  
  <div id="map"></div>
  <div id="panel">
    <button id="clearBtn">清除</button>
    <span id="info">总距离：0 km 面积：0 km²</span>
  </div>

 <script>
    let map;
    let path = [];
    let polyline;
    let markers = [];
    let totalDistance = 0;
    let polygonClosed = false;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 0, lng: 0 },
      zoom: 2,
      mapTypeId: "terrain",
    });

    // ===== 加载河流 =====
    fetch("heliu.json")
      .then((res) => res.json())
      .then((data) => {
        function fixCoordinates(coords) {
          if (typeof coords[0] === "number" && typeof coords[1] === "number") {
            const [a, b] = coords;
            if (Math.abs(a) <= 90 && Math.abs(b) > 90) return [b, a];
            return [a, b];
          }
          return coords.map(fixCoordinates);
        }

        data.features.forEach((f) => {
          if (f.geometry && f.geometry.coordinates) {
            f.geometry.coordinates = fixCoordinates(f.geometry.coordinates);
          }
        });

        map.data.addGeoJson(data);
        map.data.setStyle({
          strokeColor: "#000000",
          strokeWeight: 3,
          strokeOpacity: 1,
        });

        map.data.addListener("click", (e) => {
          const name = e.feature.getProperty("name") || "未命名河流";
          if (infoWindow) infoWindow.close();
          infoWindow = new google.maps.InfoWindow({
            content: `<b>${name}</b>`,
            position: e.latLng,
          });
          infoWindow.open(map);
        });
      });

    // ===== 测距线初始化 =====
    polyline = new google.maps.Polyline({
        path: path,
        geodesic: true,
        strokeColor: "#FF0000",
        strokeWeight: 3,
        map: map
      });

      map.addListener("click", (e) => {
        if (polygonClosed) return;

        const clickedLatLng = e.latLng;
			path.push(clickedLatLng);
			addMarker(clickedLatLng);
			updatePolyline();
			recalcDistanceAndArea();
      });

      document.getElementById("clearBtn").addEventListener("click", clearAll);
    }

    function addMarker(latLng){
      const marker = new google.maps.Marker({
        position: latLng,
        map: map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 4,
          fillColor: "#000000",
          fillOpacity: 1,
          strokeColor: "#FFFFFF",
          strokeWeight: 1
        },
        clickable: false
      });
      markers.push(marker);
    }

    function updatePolyline(){
      polyline.setPath(path);
    }



    function clearAll(){
      path = [];
      totalDistance = 0;
      polygonClosed = false;
      polyline.setPath([]);
      markers.forEach(m => m.setMap(null));
      markers = [];
      document.getElementById("info").innerText = "总距离：0 km 面积：0 km²";
    }

</script>




    
  </body>
</html>










