<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>闭合多边形测面积</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; width: 100%; }
    #panel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: sans-serif;
      z-index: 999;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <button id="clearBtn">清除</button>
    <span id="info">总距离：0 km 面积：0 km²</span>
  </div>

  <script>
    let map;
    let path = [];
    let polyline;
    let markers = [];
    let totalDistance = 0;
    let polygonClosed = false;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: {lat:0, lng:0},
        zoom: 2,
        mapTypeId: "terrain"
      });

      polyline = new google.maps.Polyline({
        path: path,
        geodesic: true,
        strokeColor: "#FF0000",
        strokeWeight: 3,
        map: map
      });

      map.addListener("click", (e) => {
        if (polygonClosed) return; // 闭合后禁止继续点击
        const clickedLatLng = e.latLng;

        // 如果距离第一个点很近，自动闭合
        if (path.length >= 3 && clickedLatLng.distanceTo(path[0]) < 10000) { 
          // 小于10km就闭合
          path.push(path[0]); // 收尾相连
          polygonClosed = true;
          updatePolyline();
          recalcDistanceAndArea();
          return;
        }

        path.push(clickedLatLng);
        addMarker(clickedLatLng);
        updatePolyline();
        recalcDistanceAndArea();
      });

      document.getElementById("clearBtn").addEventListener("click", clearAll);
    }

    function addMarker(latLng){
      const marker = new google.maps.Marker({
        position: latLng,
        map: map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 4.5,
          fillColor: "#000000",
          fillOpacity: 1,
          strokeColor: "#FFFFFF",
          strokeWeight: 1
        },
        clickable: false
      });
      markers.push(marker);
    }

    function updatePolyline(){
      polyline.setPath(path);
    }

    function recalcDistanceAndArea(){
      totalDistance = 0;
      for(let i=1; i<path.length; i++){
        totalDistance += haversineDistance(path[i-1], path[i]);
      }
      let area = 0;
      if(polygonClosed){
        area = google.maps.geometry.spherical.computeArea(path)/1e6; // km²
      }
      document.getElementById("info").innerText = 
        `总距离：${totalDistance.toFixed(2)} km 面积：${area.toFixed(2)} km²`;
    }

    function clearAll(){
      path = [];
      totalDistance = 0;
      polygonClosed = false;
      polyline.setPath([]);
      markers.forEach(m => m.setMap(null));
      markers = [];
      document.getElementById("info").innerText = "总距离：0 km 面积：0 km²";
    }

    function haversineDistance(p1,p2){
      const R = 6371;
      const lat1 = p1.lat()*Math.PI/180;
      const lat2 = p2.lat()*Math.PI/180;
      const dLat = lat2 - lat1;
      const dLng = (p2.lng()-p1.lng())*Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
  </script>



    <!-- 用老版 JS API 正确加载 --> <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1DDVsoYSslYif9JG1EmZt04uUWiZGJgE&callback=initMap"> </script>
  </body>
</html>






