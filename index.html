<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>河流地图 + 测距工具</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
        width: 100%;
      }
      #panel {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: white;
        padding: 8px 12px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        font-family: sans-serif;
        z-index: 999;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div id="panel">
      <button id="clearBtn">清除测距</button>
      <span id="distance">总距离：0 km</span>
    </div>

    <script>
      let map;
      let path = [];
      let polyline;
      let totalDistance = 0;
      let markers = [];

      function initMap() {
        // 初始化地图
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 0, lng: 0 },
          zoom: 2,
          mapTypeId: "terrain"
        });

        // 加载河流 GeoJSON 文件
        fetch('heliu.json')
          .then(res => res.json())
          .then(data => {
            // 修复坐标格式
            function fixCoordinates(coords) {
              if (typeof coords[0] === "number" && typeof coords[1] === "number") {
                const [a, b] = coords;
                if (Math.abs(a) <= 90 && Math.abs(b) > 90) {
                  return [b, a];
                }
                return [a, b];
              }
              return coords.map(fixCoordinates);
            }

            data.features.forEach(f => {
              if (f.geometry && f.geometry.coordinates) {
                f.geometry.coordinates = fixCoordinates(f.geometry.coordinates);
              }
            });

            map.data.addGeoJson(data);
            map.data.setStyle({
              strokeColor: "#0000FF",
              strokeWeight: 2,
              strokeOpacity: 0.8
            });

            map.data.addListener("click", e => {
              const name = e.feature.getProperty("name") || "未命名河流";
              new google.maps.InfoWindow({
                content: `<b>${name}</b>`,
                position: e.latLng
              }).open(map);
            });
          })
          .catch(err => console.error("加载 GeoJSON 失败:", err));

        // 初始化测距线
        polyline = new google.maps.Polyline({
          path: path,
          geodesic: true,
          strokeColor: "#FF0000",
          strokeOpacity: 0.8,
          strokeWeight: 2,
          map: map
        });

        // 点击地图测距
        map.addListener("click", (e) => {
          path.push(e.latLng);
          polyline.setPath(path);
          if (path.length > 1) {
            const last = path[path.length - 2];
            const dist = haversineDistance(last, e.latLng);
            totalDistance += dist;
            document.getElementById("distance").innerText = `总距离：${totalDistance.toFixed(2)} km`;
          }
          const marker = new google.maps.Marker({
            position: e.latLng,
            map: map,
            title: `点 ${path.length}`
          });
          markers.push(marker);
        });

        // 清除按钮功能
        document.getElementById("clearBtn").addEventListener("click", () => {
          path = [];
          totalDistance = 0;
          polyline.setPath([]);
          document.getElementById("distance").innerText = "总距离：0 km";
          markers.forEach(m => m.setMap(null));
          markers = [];
        });
      }

      // 计算两点间球面距离
      function haversineDistance(p1, p2) {
        const R = 6371; // 地球半径 (km)
        const lat1 = p1.lat() * Math.PI / 180;
        const lat2 = p2.lat() * Math.PI / 180;
        const dLat = lat2 - lat1;
        const dLng = (p2.lng() - p1.lng()) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 +
                  Math.cos(lat1) * Math.cos(lat2) *
                  Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(a));
      }
    </script>

    <!-- Google Maps JS -->
    <script async
      src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap">
    </script>
  </body>
</html>

